---
title: "Almond Profit Model"
author: "Zach Loo & Nico Gavigan"
---

```{r}
library(tidyverse)
```

- price per unit * yield = revenue
    - yield would vary, assume baseline yield
- costs = fixed costs + variable costs
- revenue - costs = profit


```{mermaid}

```

```{r}
climate_df <- read_table(here::here("3_almondyield", "data", "clim.txt")) |> 
    janitor::clean_names()
```

```{r}
# Function structure
baseline_yield <- 500
unit_price <- 3
unit_cost <- 1
unit_cost_uncertain <- 0.20

# Yearly Minimum Feb temps
feb_temps_yearly <- data |> 
filter(month == 2) |> 
group_by(year) |> 
summarise(feb_min_temps = min(tmin_c)) |> 
pull(feb_min_temps)

# Yearly January precip
jan_precip_yearly <- data |> 
filter(month == 1) |> 
group_by(year) |> 
summarise(jan_precip_sum = sum(precip)) |> 
pull(jan_precip_sum)

# Years
years <- data |> 
    filter(month == 1) |> 
    pull(year) |> 
    unique()
# Anomaly yields
yield_anomalies <- -0.015 * feb_temps_yearly - 0.0046 * feb_temps_yearly^2 - 
                     0.07 * jan_precip_yearly + 0.0043 * jan_precip_yearly^2 + 0.28

# Total yields
total_yields <- baseline_yield + yield_anomalies

# Varying unit cost
varying_unit_cost <- unit_cost + rnorm(n = length(years), mean = 0, sd = unit_cost_uncertain)

# Profit
profit <- total_yields * (unit_price - varying_unit_cost)

output_df  <- data.frame(
year = years,
yield = total_yields,
unit_cost = varying_unit_cost,
profit = profit
)
```

```{r}
source(here::here("4_almondprofit", "almond_profit.R"))
```

```{r}
# Call function
df1 <- calculate_almond_profit(data = climate_df, unit_price = 3, unit_cost = 1, unit_cost_uncertain = 0.15)

df2 <- calculate_almond_profit(data = climate_df, unit_price = 2, unit_cost = 1.8, unit_cost_uncertain = 0.40)
```
```{r}
# Final plot
ggplot() +
    geom_line(data = df1, aes(x = year, y = profit)) +
    geom_line(data = df2, aes(x = year, y = profit))

```